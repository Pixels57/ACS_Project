#!/usr/bin/env python3
"""
Proof of Concept: TLS Certificate Misconfiguration
Demonstrates certificate validation failures due to misconfigured certificate

This PoC generates a misconfigured certificate locally for demonstration purposes.
It does NOT modify the application's certificate files.
"""

import requests
import ssl
import socket
from cryptography import x509
from cryptography.x509.oid import NameOID
from cryptography.hazmat.primitives import hashes, serialization
from cryptography.hazmat.primitives.asymmetric import rsa
from cryptography.hazmat.backends import default_backend
from datetime import datetime, timedelta, timezone
import os

def generate_misconfigured_cert_local(output_dir):
    """
    Generate a misconfigured certificate in the PoC directory for demonstration
    This does NOT affect the application's certificate files
    """
    # Generate Key - Using 2048-bit (minimum required by OpenSSL)
    key = rsa.generate_private_key(public_exponent=65537, key_size=2048)
    
    # VULNERABLE: Wrong Common Name - doesn't match the actual server domain
    subject = issuer = x509.Name([
        x509.NameAttribute(NameOID.COUNTRY_NAME, u"US"),
        x509.NameAttribute(NameOID.STATE_OR_PROVINCE_NAME, u"Test"),
        x509.NameAttribute(NameOID.ORGANIZATION_NAME, u"Vulnerable Server"),
        x509.NameAttribute(NameOID.COMMON_NAME, u"wrong-domain.example.com"),  # VULNERABLE: Wrong CN
    ])
    
    # VULNERABLE: Expired certificate - valid from 1 year ago to 6 months ago
    now = datetime.now(timezone.utc)
    not_valid_before = now - timedelta(days=365)
    not_valid_after = now - timedelta(days=180)  # Expired 6 months ago
    
    signature_algorithm = hashes.SHA256()
    
    cert = x509.CertificateBuilder().subject_name(
        subject
    ).issuer_name(
        issuer
    ).public_key(
        key.public_key()
    ).serial_number(
        x509.random_serial_number()
    ).not_valid_before(
        not_valid_before
    ).not_valid_after(
        not_valid_after  # VULNERABLE: Certificate is expired
    ).sign(key, signature_algorithm)
    
    # Write certificate and key files to PoC directory
    cert_path = os.path.join(output_dir, "misconfigured_cert.pem")
    key_path = os.path.join(output_dir, "misconfigured_key.pem")
    
    with open(key_path, "wb") as f:
        f.write(key.private_bytes(
            serialization.Encoding.PEM,
            serialization.PrivateFormat.TraditionalOpenSSL,
            serialization.NoEncryption()
        ))
    
    with open(cert_path, "wb") as f:
        f.write(cert.public_bytes(serialization.Encoding.PEM))
    
    return cert_path, key_path

def test_certificate_misconfiguration():
    """
    Test and demonstrate certificate misconfiguration vulnerabilities
    This PoC generates a misconfigured certificate locally for demonstration.
    It does NOT modify the application's certificate files.
    """
    print("=" * 70)
    print("TLS Certificate Misconfiguration - Proof of Concept")
    print("=" * 70)
    print()
    print("[!] This PoC demonstrates the VULNERABLE misconfigured certificate")
    print("[!] Certificate will be generated locally in this directory")
    print("[!] This does NOT affect the application's certificate files")
    print()
    
    # Use local directory for PoC certificate
    poc_dir = os.path.dirname(os.path.abspath(__file__))
    cert_path = os.path.join(poc_dir, "misconfigured_cert.pem")
    
    # Generate misconfigured certificate if it doesn't exist
    if not os.path.exists(cert_path):
        print("[+] Generating misconfigured certificate for PoC...")
        try:
            cert_path, key_path = generate_misconfigured_cert_local(poc_dir)
            print(f"[+] Misconfigured certificate generated: {cert_path}")
            print("    - Expired validity (expired 6 months ago)")
            print("    - Wrong Common Name (wrong-domain.example.com)")
            print("    - Missing Subject Alternative Names")
        except Exception as e:
            print(f"[ERROR] Failed to generate certificate: {e}")
            return
    else:
        print(f"[+] Using existing misconfigured certificate: {cert_path}")
    
    # Test 1: Read certificate details and identify vulnerabilities
    print("[1] Certificate Details Analysis:")
    print("-" * 70)
    vulnerabilities_found = []
    cert = None
    
    try:
        with open(cert_path, "rb") as f:
            cert = x509.load_pem_x509_certificate(f.read(), default_backend())
        
        print(f"Subject: {cert.subject}")
        print(f"Issuer: {cert.issuer}")
        print(f"Valid from: {cert.not_valid_before}")
        print(f"Valid until: {cert.not_valid_after}")
        
        # Check if expired
        now = datetime.now(cert.not_valid_before.tzinfo)
        if now > cert.not_valid_after:
            print("[VULNERABILITY] Certificate is EXPIRED!")
            vulnerabilities_found.append("Expired certificate")
        elif now < cert.not_valid_before:
            print("[VULNERABILITY] Certificate is not yet valid!")
            vulnerabilities_found.append("Certificate not yet valid")
        else:
            print("[OK] Certificate is currently valid (NOT a misconfigured cert)")
        
        # Check Common Name
        cn = None
        for attr in cert.subject:
            if attr.oid == x509.oid.NameOID.COMMON_NAME:
                cn = attr.value
                break
        
        if cn != "localhost":
            print(f"[VULNERABILITY] Wrong Common Name: {cn} (expected: localhost)")
            vulnerabilities_found.append(f"Wrong CN: {cn}")
        else:
            print(f"[OK] Common Name is correct: {cn} (This is the TRUSTED cert, not misconfigured)")
        
        # Check for SANs
        try:
            san_ext = cert.extensions.get_extension_for_oid(x509.oid.ExtensionOID.SUBJECT_ALTERNATIVE_NAME)
            print(f"[OK] Subject Alternative Names present (This is the TRUSTED cert)")
        except x509.ExtensionNotFound:
            print("[VULNERABILITY] Missing Subject Alternative Names (SAN)")
            vulnerabilities_found.append("Missing SAN")
        
        # Verify this is the misconfigured cert
        if not vulnerabilities_found:
            print()
            print("[!] WARNING: This certificate appears to be properly configured!")
            print("[!] Expected misconfigured certificate with:")
            print("    - Expired validity")
            print("    - Wrong Common Name (wrong-domain.example.com)")
            print("    - Missing SAN")
            print()
            print("[!] Regenerating misconfigured certificate...")
            try:
                os.remove(cert_path)
                cert_path, _ = generate_misconfigured_cert_local(poc_dir)
                print("[+] Regenerated misconfigured certificate")
                print("[!] Please run this PoC again to see the vulnerabilities")
                return
            except Exception as e:
                print(f"[ERROR] Failed to regenerate: {e}")
        
    except Exception as e:
        print(f"[ERROR] Failed to read certificate: {e}")
        return
    
    if not cert:
        print("[ERROR] Could not load certificate")
        return
    
    print()
    
    # Test 2: Demonstrate certificate validation with the misconfigured cert
    print("[2] Certificate Validation Test (using misconfigured certificate):")
    print("-" * 70)
    print("[INFO] This demonstrates what happens when a client validates the misconfigured certificate")
    print()
    
    # Show what validation failures would occur
    print("Attempting to validate misconfigured certificate...")
    print("[EXPECTED] Certificate validation will fail due to:")
    if "Expired certificate" in vulnerabilities_found:
        print("  - Certificate is expired")
    if any("Wrong CN" in v for v in vulnerabilities_found):
        print("  - Wrong Common Name (hostname mismatch)")
    if "Missing SAN" in vulnerabilities_found:
        print("  - Missing Subject Alternative Names")
    print()
    print("[VULNERABILITY] This demonstrates why misconfigured certificates are dangerous:")
    print("  - Clients cannot verify certificate authenticity")
    print("  - Browsers show security warnings")
    print("  - Automated tools fail validation")
    print("  - Users may bypass warnings, enabling man-in-the-middle attacks")
    
    print()
    
    # Test 3: Show what happens if validation is bypassed (demonstrates risk)
    print("[3] Risk Demonstration (bypassing certificate validation):")
    print("-" * 70)
    print("[WARNING] This demonstrates the risk of bypassing certificate validation")
    print()
    print("In real scenarios, users might:")
    print("  - Click 'Advanced' -> 'Proceed anyway' in browser")
    print("  - Use verify=False in code (as shown below)")
    print("  - Disable certificate validation in tools")
    print()
    print("Example vulnerable code:")
    print("  response = requests.get('https://example.com', verify=False)  # DANGEROUS!")
    print()
    print("[VULNERABILITY] Bypassing validation allows:")
    print("  - Man-in-the-middle attacks")
    print("  - Connection to malicious servers")
    print("  - Data interception")
    print("  - Identity spoofing")
    
    print()
    print("=" * 70)
    print("Summary:")
    print("=" * 70)
    
    if vulnerabilities_found:
        print(f"[VULNERABILITY] Found {len(vulnerabilities_found)} certificate misconfigurations:")
        for vuln in vulnerabilities_found:
            print(f"  - {vuln}")
        print()
        print("The misconfigured certificate causes:")
        print("  - Certificate validation failures")
        print("  - Browser security warnings")
        print("  - Potential for man-in-the-middle attacks")
        print("  - Automated tool failures")
    else:
        print("[INFO] No vulnerabilities detected - certificate appears to be properly configured")
        print("       This PoC is designed to test the MISCONFIGURED certificate.")
        print("       See instructions above to switch to misconfigured certificate.")
    
    print()
    print("Remediation: See issues/REM-003-TLS-Certificate.md")

if __name__ == "__main__":
    test_certificate_misconfiguration()

